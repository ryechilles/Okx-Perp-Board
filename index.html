<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKX Board v1.4</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fafafa;
      color: #1a1a1a;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Sticky Header Area */
    .sticky-header {
      background: #fafafa;
      z-index: 100;
      padding: 20px 24px 0 24px;
      flex-shrink: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 16px;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
    }

    /* Tabs - Pill Style */
    .tabs {
      display: inline-flex;
      background: #f0f0f0;
      border-radius: 8px;
      padding: 4px;
      gap: 2px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: transparent;
    }

    .tab:hover:not(.disabled) {
      color: #1a1a1a;
    }

    .tab.active {
      background: #fff;
      color: #1a1a1a;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .tab.disabled {
      color: #bbb;
      cursor: not-allowed;
    }

    /* Controls Row */
    .controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    /* Toggle Group */
    .toggle-group {
      display: inline-flex;
      background: #f0f0f0;
      border-radius: 8px;
      padding: 4px;
    }

    .toggle-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: transparent;
    }

    .toggle-btn:hover {
      color: #1a1a1a;
    }

    .toggle-btn.active {
      background: #fff;
      color: #1a1a1a;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* Dropdown */
    .dropdown {
      position: relative;
    }

    .dropdown-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      height: 36px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dropdown-btn:hover {
      border-color: #ccc;
    }

    .dropdown-label {
      color: #666;
    }

    .dropdown-arrow {
      font-size: 10px;
      color: #999;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 120px;
      z-index: 200;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 10px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .dropdown-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    /* Search */
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      height: 36px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }

    .search-box input {
      border: none;
      outline: none;
      font-size: 14px;
      width: 150px;
    }

    .search-icon {
      color: #999;
      font-size: 14px;
    }

    /* Filter Button */
    .filter-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 12px;
      height: 36px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .filter-btn:hover {
      border-color: #ccc;
      color: #1a1a1a;
    }

    .filter-btn.has-filter {
      border-color: #3b82f6;
      color: #3b82f6;
      background: #eff6ff;
    }

    /* RSI Average Display */
    .rsi-avg-display {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
      padding: 0 14px;
      height: 36px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }

    .rsi-avg-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .rsi-avg-label {
      font-size: 12px;
      color: #888;
    }

    .rsi-avg-value {
      font-size: 14px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .rsi-avg-value.oversold {
      color: #22c55e;
    }

    .rsi-avg-value.overbought {
      color: #ef4444;
    }

    .rsi-avg-value.neutral {
      color: #1a1a1a;
    }

    /* Filter Panel */
    .filter-panel {
      display: none;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .filter-panel.show {
      display: block;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-item label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .filter-item select {
      padding: 8px 10px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
      background: #fff;
      cursor: pointer;
      width: 100%;
    }

    .filter-item select:focus {
      border-color: #3b82f6;
    }

    .filter-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .filter-actions button {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-apply {
      background: #1a1a1a;
      color: #fff;
      border: none;
    }

    .btn-apply:hover {
      background: #333;
    }

    .btn-clear {
      background: #fff;
      color: #666;
      border: 1px solid #e5e5e5;
    }

    .btn-clear:hover {
      border-color: #ccc;
    }

    /* Table Header Bar */
    .table-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      margin-bottom: 0;
      background: #fafafa;
    }

    .table-header-bar .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: #999;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      margin-right: 6px;
      display: inline-block;
    }

    .progress-text {
      font-size: 11px;
      color: #999;
    }

    /* Table Container with Sticky Header */
    .table-area {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 0 24px;
    }

    .table-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .table-container {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* Fixed Table Header */
    .table-header {
      flex-shrink: 0;
      background: #fafafa;
      border-bottom: 1px solid #f0f0f0;
    }

    .table-header table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    /* Scrollbar Styling */
    .table-body-wrapper::-webkit-scrollbar {
      width: 8px;
    }

    .table-body-wrapper::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-body-wrapper::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      transition: background 0.2s;
    }

    .table-body-wrapper:hover::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.3);
    }

    .table-body-wrapper::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.5);
    }

    /* Firefox */
    .table-body-wrapper {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
    }

    .table-body-wrapper:hover {
      scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
    }

    .table-body-wrapper {
      flex: 1;
      overflow-y: auto;
    }

    .table-body-wrapper table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 500;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #fafafa;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: background 0.1s;
    }

    th:hover {
      background: #f0f0f0;
    }

    th.align-right {
      text-align: right;
    }

    th .sort-icon {
      margin-left: 4px;
      opacity: 0.3;
    }

    th.sort-asc .sort-icon,
    th.sort-desc .sort-icon {
      opacity: 1;
    }

    td {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid #f5f5f5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td.align-right {
      text-align: right;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #fafafa;
    }

    /* Column widths */
    .col-fav { width: 36px; }
    .col-symbol { width: 140px; }
    .col-price { width: 110px; }
    .col-change { width: 100px; }
    .col-change7d { width: 100px; }
    .col-cap { width: 110px; }
    .col-rsi { width: 70px; }
    .col-spot { width: 70px; }

    .symbol {
      font-weight: 600;
    }

    .symbol-base {
      color: #1a1a1a;
    }

    .symbol-quote {
      color: #999;
      font-weight: 400;
    }

    .price {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .change {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .change.positive {
      color: #22c55e;
    }

    .change.negative {
      color: #ef4444;
    }

    .muted {
      color: #666;
      font-variant-numeric: tabular-nums;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-yes {
      background: #dcfce7;
      color: #16a34a;
    }

    .badge-no {
      background: #f3f4f6;
      color: #9ca3af;
    }

    .rsi {
      font-variant-numeric: tabular-nums;
    }

    .rsi-oversold {
      color: #22c55e;
    }

    .rsi-overbought {
      color: #ef4444;
    }

    .rsi-neutral {
      color: #666;
    }

    .rsi-loading {
      color: #ccc;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: #999;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e5e5;
      border-top-color: #1a1a1a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Favorite Star */
    .favorite-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #ddd;
      transition: color 0.15s;
    }

    .favorite-btn:hover {
      color: #fbbf24;
    }

    .favorite-btn.active {
      color: #fbbf24;
    }

    /* Footer */
    .table-footer {
      padding: 12px 16px;
      font-size: 12px;
      color: #999;
      border-top: 1px solid #f0f0f0;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <!-- Sticky Header -->
  <div class="sticky-header">
    <div class="container">
      <!-- Header with Tabs -->
      <div class="header">
        <div class="logo">OKX Board <span style="font-size:12px;color:#999;font-weight:400;">v1.4</span></div>
        <div class="tabs">
          <button class="tab active" data-tab="perp">Perp</button>
          <button class="tab disabled" data-tab="spot">Spot <span style="font-size:10px;color:#bbb;">(Soon)</span></button>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="toggle-group">
          <button class="toggle-btn active" data-view="market">Market</button>
          <button class="toggle-btn" data-view="favorites">Favorites</button>
        </div>

        <div class="dropdown">
          <button class="dropdown-btn" onclick="toggleDropdown()">
            <span class="dropdown-label">Base:</span>
            <span id="selectedQuote">USDT</span>
            <span class="dropdown-arrow">‚ñº</span>
          </button>
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" onclick="selectQuote('USDT')">USDT</div>
            <div class="dropdown-item" onclick="selectQuote('BTC')">BTC</div>
            <div class="dropdown-item" onclick="selectQuote('ETH')">ETH</div>
          </div>
        </div>

        <button class="filter-btn" id="filterBtn" onclick="toggleFilterPanel()">
          <span>‚öô</span> Filters
        </button>

        <!-- RSI Average Display -->
        <div class="rsi-avg-display">
          <div class="rsi-avg-item">
            <span class="rsi-avg-label">Avg RSI7</span>
            <span class="rsi-avg-value" id="avgRsi7">--</span>
          </div>
          <div class="rsi-avg-item">
            <span class="rsi-avg-label">Avg RSI14</span>
            <span class="rsi-avg-value" id="avgRsi14">--</span>
          </div>
        </div>

        <!-- Search moved to right -->
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Search symbol..." oninput="renderTable()">
        </div>
      </div>

      <!-- Filter Panel -->
      <div class="filter-panel" id="filterPanel">
        <div class="filter-grid">
          <div class="filter-item">
            <label>Market Cap</label>
            <select id="filterMarketCap">
              <option value="">All</option>
              <option value="<30M">&lt; $30M</option>
              <option value="30M-1B">$30M - $1B</option>
              <option value=">1B">&gt; $1B</option>
            </select>
          </div>
          <div class="filter-item">
            <label>RSI7</label>
            <select id="filterRsi7">
              <option value="">All</option>
              <option value="<30">&lt; 30 (Oversold)</option>
              <option value="30-70">30 - 70</option>
              <option value=">70">&gt; 70 (Overbought)</option>
            </select>
          </div>
          <div class="filter-item">
            <label>RSI14</label>
            <select id="filterRsi14">
              <option value="">All</option>
              <option value="<30">&lt; 30 (Oversold)</option>
              <option value="30-70">30 - 70</option>
              <option value=">70">&gt; 70 (Overbought)</option>
            </select>
          </div>
          <div class="filter-item" id="filterHasSpotItem">
            <label>Has Spot</label>
            <select id="filterHasSpot">
              <option value="">All</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="filter-actions">
          <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
          <button class="btn-clear" onclick="clearFilters()">Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Area -->
  <div class="table-area">
    <div class="table-wrapper">
      <div class="table-container">
        <!-- Status Bar at top right -->
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #f0f0f0;">
          <span id="countText" style="font-size:12px; color:#999;">--</span>
          <div class="status-info">
            <span class="progress-text" id="progressText"></span>
            <div>
              <span class="status-dot"></span>
              <span id="statusText">Connecting...</span>
            </div>
            <span id="updateTime">--</span>
          </div>
        </div>

        <!-- Fixed Table Header -->
        <div class="table-header">
          <table>
            <thead>
              <tr>
                <th class="col-fav"></th>
                <th class="col-symbol" data-sort="symbol">Token <span class="sort-icon">‚Üï</span></th>
                <th class="col-price align-right" data-sort="price">Price <span class="sort-icon">‚Üï</span></th>
                <th class="col-change align-right" data-sort="change">24h Change <span class="sort-icon">‚Üï</span></th>
                <th class="col-change7d align-right" data-sort="change7d">7D Change <span class="sort-icon">‚Üï</span></th>
                <th class="col-cap align-right" data-sort="marketCap">Market Cap <span class="sort-icon">‚Üï</span></th>
                <th class="col-rsi align-right" data-sort="rsi7">RSI7 <span class="sort-icon">‚Üï</span></th>
                <th class="col-rsi align-right" data-sort="rsi14">RSI14 <span class="sort-icon">‚Üï</span></th>
                <th class="col-spot" data-sort="hasSpot" id="hasSpotHeader">Spot <span class="sort-icon">‚Üï</span></th>
              </tr>
            </thead>
          </table>
        </div>

        <!-- Scrollable Table Body -->
        <div class="table-body-wrapper">
          <table>
            <tbody id="tableBody">
              <tr>
                <td colspan="9">
                  <div class="loading">
                    <div class="spinner"></div>
                    Loading market data...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let allTickers = [];
    let spotSymbols = new Set();
    let rsiData = {};
    let change7dData = {}; // 7D change data
    let marketCapData = {};
    let coinGeckoIdMap = {};
    let currentQuote = 'USDT';
    let currentView = 'market';
    let currentInstType = 'SWAP'; // Default to Perp
    let favorites = JSON.parse(localStorage.getItem('okx-favorites') || '[]');
    
    // Sorting
    let sortColumn = 'marketCap';
    let sortDirection = 'desc';
    
    // Filters
    let filters = {};

    const instTypeMap = {
      'spot': 'SPOT',
      'perp': 'SWAP'
    };

    // Fetch CoinGecko market data (includes 7d change)
    async function fetchCoinGeckoData() {
      try {
        updateProgress('Loading market data...');
        
        const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false&price_change_percentage=7d');
        const data = await response.json();
        
        data.forEach(coin => {
          const symbol = coin.symbol.toUpperCase();
          marketCapData[symbol] = coin.market_cap;
          change7dData[symbol] = coin.price_change_percentage_7d_in_currency;
          coinGeckoIdMap[symbol] = coin.id;
        });
        
        updateProgress('');
        renderTable();
      } catch (e) {
        console.error('Failed to fetch CoinGecko data:', e);
        updateProgress('CoinGecko rate limited');
      }
    }

    // Fetch tickers from OKX
    async function fetchTickers() {
      try {
        const response = await fetch(`https://www.okx.com/api/v5/market/tickers?instType=${currentInstType}`);
        const data = await response.json();
        
        if (data.code === '0') {
          allTickers = data.data.map(t => {
            const parts = t.instId.split('-');
            const baseSymbol = parts[0];
            
            return {
              ...t,
              baseSymbol,
              priceNum: parseFloat(t.last) || 0,
              changeNum: parseFloat(t.sodUtc8) > 0 
                ? ((parseFloat(t.last) - parseFloat(t.sodUtc8)) / parseFloat(t.sodUtc8) * 100)
                : 0
            };
          });
          
          renderTable();
          updateStatus('Live', new Date().toLocaleTimeString());
          
          fetchRsiForVisible();
        }
      } catch (error) {
        console.error('Failed to fetch:', error);
        updateStatus('Error', 'Failed to connect');
      }
    }

    // Fetch all spot symbols
    async function fetchSpotSymbols() {
      try {
        const response = await fetch('https://www.okx.com/api/v5/market/tickers?instType=SPOT');
        const data = await response.json();
        if (data.code === '0') {
          spotSymbols = new Set(data.data.map(t => {
            const parts = t.instId.split('-');
            return parts[0] + '-' + parts[1];
          }));
        }
      } catch (e) {
        console.error('Failed to fetch spot symbols:', e);
      }
    }

    // Calculate RSI
    function calculateRSI(closes, period) {
      if (closes.length < period + 1) return null;
      
      let gains = 0;
      let losses = 0;
      
      for (let i = 1; i <= period; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) gains += change;
        else losses -= change;
      }
      
      let avgGain = gains / period;
      let avgLoss = losses / period;
      
      for (let i = period + 1; i < closes.length; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) - change) / period;
        }
      }
      
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    // Fetch RSI for a single instrument
    async function fetchRsiForInstrument(instId) {
      try {
        const response = await fetch(`https://www.okx.com/api/v5/market/candles?instId=${instId}&bar=1D&limit=30`);
        const data = await response.json();
        
        if (data.code === '0' && data.data.length >= 15) {
          const candles = data.data.reverse();
          const closes = candles.map(c => parseFloat(c[4]));
          
          const rsi7 = calculateRSI(closes, 7);
          const rsi14 = calculateRSI(closes, 14);
          
          rsiData[instId] = { rsi7, rsi14 };
        }
      } catch (e) {
        console.error(`Failed to fetch RSI for ${instId}:`, e);
      }
    }

    // Fetch RSI for visible items
    async function fetchRsiForVisible() {
      const filtered = getFilteredData();
      const toFetch = filtered.filter(t => !rsiData[t.instId]);
      
      if (toFetch.length === 0) return;
      
      for (let i = 0; i < toFetch.length; i++) {
        updateProgress(`RSI ${i + 1}/${toFetch.length}`);
        await fetchRsiForInstrument(toFetch[i].instId);
        renderTable();
        
        if (i < toFetch.length - 1) {
          await new Promise(r => setTimeout(r, 350));
        }
      }
      
      updateProgress('');
    }

    // Get filtered and sorted data
    function getFilteredData() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = allTickers;
      
      if (currentInstType === 'SPOT') {
        filtered = filtered.filter(t => t.instId.endsWith('-' + currentQuote));
      } else {
        filtered = filtered.filter(t => t.instId.includes('-' + currentQuote + '-'));
      }
      
      if (searchTerm) {
        filtered = filtered.filter(t => t.instId.toLowerCase().includes(searchTerm));
      }
      
      if (currentView === 'favorites') {
        filtered = filtered.filter(t => favorites.includes(t.instId));
      }
      
      // Apply filters
      if (filters.marketCap) {
        if (filters.marketCap === '<30M') {
          filtered = filtered.filter(t => (marketCapData[t.baseSymbol] || 0) < 30000000);
        } else if (filters.marketCap === '30M-1B') {
          filtered = filtered.filter(t => {
            const cap = marketCapData[t.baseSymbol] || 0;
            return cap >= 30000000 && cap <= 1000000000;
          });
        } else if (filters.marketCap === '>1B') {
          filtered = filtered.filter(t => (marketCapData[t.baseSymbol] || 0) > 1000000000);
        }
      }
      
      if (filters.rsi7) {
        if (filters.rsi7 === '<30') {
          filtered = filtered.filter(t => (rsiData[t.instId]?.rsi7 || 50) < 30);
        } else if (filters.rsi7 === '30-70') {
          filtered = filtered.filter(t => {
            const rsi = rsiData[t.instId]?.rsi7;
            return rsi !== undefined && rsi >= 30 && rsi <= 70;
          });
        } else if (filters.rsi7 === '>70') {
          filtered = filtered.filter(t => (rsiData[t.instId]?.rsi7 || 50) > 70);
        }
      }
      
      if (filters.rsi14) {
        if (filters.rsi14 === '<30') {
          filtered = filtered.filter(t => (rsiData[t.instId]?.rsi14 || 50) < 30);
        } else if (filters.rsi14 === '30-70') {
          filtered = filtered.filter(t => {
            const rsi = rsiData[t.instId]?.rsi14;
            return rsi !== undefined && rsi >= 30 && rsi <= 70;
          });
        } else if (filters.rsi14 === '>70') {
          filtered = filtered.filter(t => (rsiData[t.instId]?.rsi14 || 50) > 70);
        }
      }
      
      if (filters.hasSpot !== undefined && filters.hasSpot !== '') {
        filtered = filtered.filter(t => {
          const baseQuote = t.instId.split('-')[0] + '-' + t.instId.split('-')[1];
          const hasSpot = spotSymbols.has(baseQuote);
          return filters.hasSpot === 'yes' ? hasSpot : !hasSpot;
        });
      }
      
      // Sort
      filtered.sort((a, b) => {
        let aVal, bVal;
        
        switch (sortColumn) {
          case 'symbol':
            aVal = a.instId;
            bVal = b.instId;
            break;
          case 'price':
            aVal = a.priceNum;
            bVal = b.priceNum;
            break;
          case 'change':
            aVal = a.changeNum;
            bVal = b.changeNum;
            break;
          case 'change7d':
            aVal = change7dData[a.baseSymbol] || 0;
            bVal = change7dData[b.baseSymbol] || 0;
            break;
          case 'marketCap':
            aVal = marketCapData[a.baseSymbol] || 0;
            bVal = marketCapData[b.baseSymbol] || 0;
            break;
          case 'rsi7':
            aVal = rsiData[a.instId]?.rsi7 || 0;
            bVal = rsiData[b.instId]?.rsi7 || 0;
            break;
          case 'rsi14':
            aVal = rsiData[a.instId]?.rsi14 || 0;
            bVal = rsiData[b.instId]?.rsi14 || 0;
            break;
          case 'hasSpot':
            const aBase = a.instId.split('-')[0] + '-' + a.instId.split('-')[1];
            const bBase = b.instId.split('-')[0] + '-' + b.instId.split('-')[1];
            aVal = spotSymbols.has(aBase) ? 1 : 0;
            bVal = spotSymbols.has(bBase) ? 1 : 0;
            break;
          default:
            aVal = marketCapData[a.baseSymbol] || 0;
            bVal = marketCapData[b.baseSymbol] || 0;
        }
        
        if (typeof aVal === 'string') {
          return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
      
      return filtered;
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const filtered = getFilteredData();
      
      // Show/hide hasSpot column
      const showSpotCol = currentInstType === 'SWAP';
      document.getElementById('hasSpotHeader').style.display = showSpotCol ? '' : 'none';
      
      const display = filtered;
      
      document.getElementById('countText').textContent = `Showing ${display.length} of ${filtered.length}`;
      
      if (display.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9">
              <div class="loading">No data found</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = display.map(ticker => {
        const parts = ticker.instId.split('-');
        const base = parts[0];
        const quote = parts[1];
        const suffix = parts[2] || '';
        
        const changeClass = ticker.changeNum >= 0 ? 'positive' : 'negative';
        const changeSign = ticker.changeNum >= 0 ? '+' : '';
        const isFavorite = favorites.includes(ticker.instId);
        
        // 7D Change
        const change7d = change7dData[base];
        const change7dDisplay = change7d !== undefined ? (change7d >= 0 ? '+' : '') + change7d.toFixed(2) + '%' : '--';
        const change7dClass = change7d !== undefined ? (change7d >= 0 ? 'positive' : 'negative') : '';
        
        const rsi = rsiData[ticker.instId];
        const rsi7Display = rsi?.rsi7 !== undefined ? rsi.rsi7.toFixed(1) : '--';
        const rsi14Display = rsi?.rsi14 !== undefined ? rsi.rsi14.toFixed(1) : '--';
        const rsi7Class = getRsiClass(rsi?.rsi7);
        const rsi14Class = getRsiClass(rsi?.rsi14);
        
        const marketCap = marketCapData[base];
        const marketCapDisplay = marketCap ? formatMarketCap(marketCap) : '--';
        
        const baseQuote = base + '-' + quote;
        const hasSpot = spotSymbols.has(baseQuote);
        
        let displaySymbol = `<span class="symbol-base">${base}</span><span class="symbol-quote">/${quote}</span>`;
        
        return `
          <tr>
            <td class="col-fav">
              <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${ticker.instId}')">
                ${isFavorite ? '‚òÖ' : '‚òÜ'}
              </button>
            </td>
            <td class="col-symbol symbol">${displaySymbol}</td>
            <td class="col-price align-right price">${formatPrice(ticker.priceNum)}</td>
            <td class="col-change align-right change ${changeClass}">${changeSign}${ticker.changeNum.toFixed(2)}%</td>
            <td class="col-change7d align-right change ${change7dClass}">${change7dDisplay}</td>
            <td class="col-cap align-right muted">${marketCapDisplay}</td>
            <td class="col-rsi align-right rsi ${rsi7Class}">${rsi7Display}</td>
            <td class="col-rsi align-right rsi ${rsi14Class}">${rsi14Display}</td>
            <td class="col-spot" style="display: ${showSpotCol ? '' : 'none'}">
              <span class="badge ${hasSpot ? 'badge-yes' : 'badge-no'}">${hasSpot ? 'Yes' : 'No'}</span>
            </td>
          </tr>
        `;
      }).join('');
      
      // Update sort icons
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === sortColumn) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
          th.querySelector('.sort-icon').textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
        } else {
          th.querySelector('.sort-icon').textContent = '‚Üï';
        }
      });
      
      // Update RSI averages
      updateRsiAverages();
    }

    function getRsiClass(rsi) {
      if (rsi === undefined || rsi === null) return 'rsi-loading';
      if (rsi <= 30) return 'rsi-oversold';
      if (rsi >= 70) return 'rsi-overbought';
      return 'rsi-neutral';
    }

    function formatPrice(price) {
      if (price >= 1000) return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if (price >= 1) return price.toFixed(4);
      if (price >= 0.0001) return price.toFixed(6);
      return price.toFixed(8);
    }

    function formatMarketCap(cap) {
      if (cap >= 1e12) return '$' + (cap / 1e12).toFixed(2) + 'T';
      if (cap >= 1e9) return '$' + (cap / 1e9).toFixed(2) + 'B';
      if (cap >= 1e6) return '$' + (cap / 1e6).toFixed(2) + 'M';
      if (cap >= 1e3) return '$' + (cap / 1e3).toFixed(2) + 'K';
      return '$' + cap.toFixed(2);
    }

    function updateStatus(status, time) {
      document.getElementById('statusText').textContent = status;
      document.getElementById('updateTime').textContent = time;
    }

    function updateProgress(text) {
      document.getElementById('progressText').textContent = text;
    }

    // Update RSI averages
    function updateRsiAverages() {
      const filtered = getFilteredData();
      
      let rsi7Sum = 0, rsi7Count = 0;
      let rsi14Sum = 0, rsi14Count = 0;
      
      filtered.forEach(t => {
        const rsi = rsiData[t.instId];
        if (rsi?.rsi7 !== undefined) {
          rsi7Sum += rsi.rsi7;
          rsi7Count++;
        }
        if (rsi?.rsi14 !== undefined) {
          rsi14Sum += rsi.rsi14;
          rsi14Count++;
        }
      });
      
      const avgRsi7El = document.getElementById('avgRsi7');
      const avgRsi14El = document.getElementById('avgRsi14');
      
      if (rsi7Count > 0) {
        const avg7 = rsi7Sum / rsi7Count;
        avgRsi7El.textContent = avg7.toFixed(1);
        avgRsi7El.className = 'rsi-avg-value ' + (avg7 <= 30 ? 'oversold' : avg7 >= 70 ? 'overbought' : 'neutral');
      } else {
        avgRsi7El.textContent = '--';
        avgRsi7El.className = 'rsi-avg-value';
      }
      
      if (rsi14Count > 0) {
        const avg14 = rsi14Sum / rsi14Count;
        avgRsi14El.textContent = avg14.toFixed(1);
        avgRsi14El.className = 'rsi-avg-value ' + (avg14 <= 30 ? 'oversold' : avg14 >= 70 ? 'overbought' : 'neutral');
      } else {
        avgRsi14El.textContent = '--';
        avgRsi14El.className = 'rsi-avg-value';
      }
    }

    function toggleDropdown() {
      document.getElementById('dropdownMenu').classList.toggle('show');
    }

    function selectQuote(quote) {
      currentQuote = quote;
      document.getElementById('selectedQuote').textContent = quote;
      document.getElementById('dropdownMenu').classList.remove('show');
      rsiData = {};
      fetchTickers();
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('dropdownMenu').classList.remove('show');
      }
    });

    // Tabs (only Perp is active)
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.classList.contains('disabled')) return;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentInstType = instTypeMap[tab.dataset.tab];
        rsiData = {};
        
        // Show/hide hasSpot filter
        document.getElementById('filterHasSpotItem').style.display = currentInstType === 'SWAP' ? '' : 'none';
        
        fetchTickers();
      });
    });

    // Toggle view
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        renderTable();
      });
    });

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = col;
          sortDirection = 'desc';
        }
        renderTable();
      });
    });

    // Filter panel
    function toggleFilterPanel() {
      document.getElementById('filterPanel').classList.toggle('show');
    }

    function applyFilters() {
      filters = {};
      
      const marketCap = document.getElementById('filterMarketCap').value;
      const rsi7 = document.getElementById('filterRsi7').value;
      const rsi14 = document.getElementById('filterRsi14').value;
      const hasSpot = document.getElementById('filterHasSpot').value;
      
      if (marketCap) filters.marketCap = marketCap;
      if (rsi7) filters.rsi7 = rsi7;
      if (rsi14) filters.rsi14 = rsi14;
      if (hasSpot) filters.hasSpot = hasSpot;
      
      const hasFilters = Object.keys(filters).length > 0;
      document.getElementById('filterBtn').classList.toggle('has-filter', hasFilters);
      
      renderTable();
    }

    function clearFilters() {
      filters = {};
      document.querySelectorAll('.filter-panel select').forEach(select => select.value = '');
      document.getElementById('filterBtn').classList.remove('has-filter');
      renderTable();
    }

    function toggleFavorite(instId) {
      const index = favorites.indexOf(instId);
      if (index > -1) {
        favorites.splice(index, 1);
      } else {
        favorites.push(instId);
      }
      localStorage.setItem('okx-favorites', JSON.stringify(favorites));
      renderTable();
    }

    // Init
    fetchSpotSymbols();
    fetchCoinGeckoData();
    fetchTickers();
    
    // Refresh tickers every 10s
    setInterval(fetchTickers, 10000);
    
    // Refresh market cap every 5 min
    setInterval(fetchCoinGeckoData, 300000);
  </script>
</body>
</html>
